# Изменения проекта — Переход на ручной режим

## Что было изменено

Проект полностью переработан для работы **только в ручном режиме** через Telegram бота. Удалена вся автоматика резервного копирования.

## Детальный список изменений

### 1. Новые файлы
- **`.env.example`** — шаблон для настройки окружения (BOT_TOKEN, ALLOWED_USER_IDS и т.д.)

### 2. Упрощенная конфигурация
- **`config.yaml`** — удалены все параметры планировщика и ротации:
  - Убраны: `scheduler.backup_cron`, `scheduler.metrics_cron`
  - Убраны: `keep_hourly_days`, `keep_daily_count`, `keep_monthly_count`
  - Убраны: все параметры yearly/halfyearly копий
  - Убраны: `hourly_subdir`, `daily_subdir`, `monthly_subdir`
  - Оставлены только: `backup_dir`, `file_prefix`, `compress`, `compress_level`

### 3. Логика бэкапа (backup.py)
- **Удалена** функция `rotate_backups()` полностью
- **Изменена** структура хранения: вместо Hourly/Daily/Monthly используется структура `YYYY-MM-DD/`
- Резервные копии теперь сохраняются в подпапки по датам:
  ```
  backup_dir/
  ├── 2025-01-15/
  │   └── Zernosbyt_2025-01-15_10-30-45.zip
  ├── 2025-01-16/
  │   └── Zernosbyt_2025-01-16_09-00-12.zip
  ```
- Упрощен конструктор `BackupService` — удалены параметры ротации

### 4. Главный файл (main.py)
- **Удалено** создание и запуск `SchedulerService`
- **Удалены** функции `job_backup()` и `job_metrics()`
- **Удалены** импорты: `scheduler`, `metrics`, `time`, `datetime`, `push_status`
- Бот теперь просто запускается без планировщика

### 5. Telegram бот (bot.py)
- **Удалена** команда `/schedule` и соответствующий обработчик
- **Удалено** обновление `/help` — больше не упоминается `/schedule`
- **Упрощена** команда `/backup` — убран вызов `rotate_backups()`
- Добавлены emoji в ответы бота (✅, ⚠️, ❌)

### 6. Конфигурация (config.py)
- **Удален** класс `SchedulerConfig`
- **Упрощен** класс `BackupConfig` — удалены все поля ротации
- **Удалено** поле `scheduler` из класса `Config`
- **Упрощена** функция `load_config()` — убрана загрузка параметров планировщика и ротации

### 7. Зависимости (requirements.txt)
- **Удалено**: `APScheduler==3.10.4`
- **Удалено**: `pytz==2024.1`
- Оставлены только необходимые библиотеки для ручного режима

### 8. Документация
- **`README.md`** — полностью переписан под ручной режим:
  - Удалены упоминания расписания и автоматических ротаций
  - Добавлено описание новой структуры папок по датам
  - Удалены разделы про S3 (перенесены в опциональные)
  
- **`OPERATIONS.md`** — полностью переписана инструкция:
  - Акцент на ручной режим работы
  - Удалены разделы про cron-расписание и автоматические ротации
  - Раздел S3 переработан: теперь это опциональная возможность через внешние скрипты
  - Добавлена новая структура папок с датами

### 9. Файлы, которые больше не используются

- **`onec_backup_bot/scheduler.py`** — не удален, но больше не импортируется
  - Можно безопасно удалить вручную

**Примечание**: `metrics.py` ОСТАВЛЕН, так как используется командой `/health`

## Как работает новая система

### Создание бэкапа
1. Пользователь отправляет `/backup` в Telegram
2. Бот создает папку с текущей датой (например, `2025-01-15/`)
3. Резервная копия сохраняется в эту папку с временной меткой в имени
4. Пользователь получает уведомление об успехе/ошибке

### Структура файлов
```
D:\1C_Backups\
├── 2025-01-15\
│   ├── Zernosbyt_2025-01-15_09-30-12.zip
│   └── Zernosbyt_2025-01-15_14-45-33.zip
├── 2025-01-16\
│   └── Zernosbyt_2025-01-16_10-00-00.zip
├── backup.log
└── app.sqlite3
```

### Управление старыми копиями
Автоматическое удаление старых копий **отключено**. Пользователь должен самостоятельно:
- Удалять старые папки с датами при необходимости
- Настроить внешние скрипты для очистки (если требуется)
- Отправлять копии в облако вручную или через Windows Task Scheduler

## Миграция с предыдущей версии

Если у вас уже были бэкапы в старой структуре (Hourly/Daily/Monthly), они останутся на месте и не будут затронуты. Новые бэкапы будут создаваться в папках с датами.

## Что делать дальше

1. **Обновите `.env`** файл на основе `.env.example`
2. **Проверьте `config.yaml`** — удалите старые параметры, если остались
3. **Переустановите зависимости**:
   ```powershell
   .\.venv\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```
4. **Протестируйте**:
   ```powershell
   python main.py
   ```
5. **В Telegram отправьте**: `/help`, `/backup`, `/status`

## Опциональное: Удаление неиспользуемых файлов

Можно безопасно удалить:
```powershell
Remove-Item onec_backup_bot\scheduler.py
```

## Вопросы?

См. подробную документацию в `OPERATIONS.md` и `README.md`
